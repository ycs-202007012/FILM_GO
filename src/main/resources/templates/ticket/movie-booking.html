<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ì˜í™” ì˜ˆë§¤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/header.css}">
    <style>
        /* ì¢Œì„ ìŠ¤íƒ€ì¼ë§ */
        .seat {
            width: 40px;
            height: 40px;
            margin: 5px;
            text-align: center;
            line-height: 40px;
            border-radius: 5px;
            cursor: pointer;
        }

        .seat-available {
            background-color: #28a745; /* ì´ˆë¡ìƒ‰ - ì‚¬ìš© ê°€ëŠ¥ */
            color: white;
        }

        .seat-reserved {
            background-color: #dc3545; /* ë¹¨ê°„ìƒ‰ - ì˜ˆì•½ë¨ */
            color: white;
            cursor: not-allowed;
        }

        .seat-pending {
            background-color: #ffc107; /* ë…¸ë€ìƒ‰ - ëŒ€ê¸° ì¤‘ */
            color: white;
            cursor: not-allowed;
        }

        .seat-selected {
            background-color: #007bff; /* íŒŒë€ìƒ‰ - ì„ íƒë¨ */
            color: white;
        }

        .seat.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
<div th:replace="~{fragments/home-button :: home-header}"></div>

<div class="container mt-5">
    <h2 class="text-center fw-bold mb-4">ğŸŸ ì˜í™” ì˜ˆë§¤</h2>

    <!-- ì˜í™” ì •ë³´ -->
    <div class="card mb-4">
        <div class="card-body">
            <h3 class="fw-bold text-primary" th:text="${movie.title}"></h3>
            <p class="mb-1"><strong>ğŸ¬ ìƒì˜ê´€:</strong> <span th:text="${theaterHouse.houseName}"></span></p>
            <p class="mb-1"><strong>ğŸ¢ ê·¹ì¥:</strong> <span th:text="${theater.name}"></span></p>
            <p class="mb-1"><strong>â° ìƒì˜ ì‹œê°„:</strong>
                <span th:text="${#temporals.format(schedule.time.startTime, 'HH:mm')}"></span> ~
                <span th:text="${#temporals.format(schedule.time.endTime, 'HH:mm')}"></span>
            </p>
        </div>
    </div>

    <!-- ì¢Œì„ ì„ íƒ í¼ -->
    <form th:action th:object="${form}" method="post" onsubmit="return validateSeatSelection()">
        <!-- âœ… ì¸ì› ìˆ˜ ì„ íƒ -->
        <div class="mb-3">
            <label for="personCount" class="form-label fw-bold">ì¸ì› ìˆ˜ ì„ íƒ</label>
            <select id="personCount" class="form-select" onchange="limitSeatSelection()">
                <option value="1">1ëª…</option>
                <option value="2">2ëª…</option>
                <option value="3">3ëª…</option>
                <option value="4">4ëª…</option>
            </select>
        </div>

        <!-- ìˆ¨ê²¨ì§„ í•„ë“œë¡œ ë°ì´í„° ì „ë‹¬ -->
        <input type="hidden" th:field="*{movieId}" th:value="${movie.id}">
        <input type="hidden" id="seatIds" name="seatIds">
        <input type="hidden" id="personCountHidden" name="personCount">

        <!-- ì¢Œì„ ì„ íƒ ì˜ì—­ -->
        <div class="row justify-content-center">
            <div class="seat-map d-flex flex-wrap justify-content-center">
                <div class="seat" th:each="movieSeat : ${schedule.movieSeats}"
                     th:classappend="${movieSeat.status.name() == 'RESERVED' ? 'seat-reserved disabled' :
                                      (movieSeat.status.name() == 'PENDING' ? 'seat-pending disabled' : 'seat-available')}"
                     th:data-seat-id="${movieSeat.id}" th:text="${movieSeat.seat.seatNumber}"
                     onclick="selectSeat(this)">
                </div>
            </div>
        </div>

        <!-- ì¢Œì„ ì„ íƒ ì˜¤ë¥˜ ë©”ì‹œì§€ -->
        <div id="seatError" class="alert alert-danger mt-3" style="display: none;">
            ì„ íƒí•œ ì¸ì› ìˆ˜ë§Œí¼ ì¢Œì„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.
        </div>

        <!-- ì˜ˆë§¤ ë²„íŠ¼ -->
        <div class="text-center mt-4">
            <button type="submit" class="btn btn-primary fw-bold">ì˜ˆë§¤í•˜ê¸°</button>
            <a href="/" class="btn btn-secondary">ì·¨ì†Œ</a>
        </div>
    </form>
</div>

<!-- âœ… JavaScriptë¡œ ì¢Œì„ ì„ íƒ ë° ì¸ì› ìˆ˜ ì œí•œ ì œì–´ -->
<script>
    let selectedSeats = [];

    function selectSeat(seatElement) {
        if (seatElement.classList.contains('disabled')) return;

        const maxSeats = parseInt(document.getElementById('personCount').value);
        const seatId = seatElement.getAttribute('data-seat-id');

        if (seatElement.classList.contains('seat-selected')) {
            seatElement.classList.remove('seat-selected');
            selectedSeats = selectedSeats.filter(id => id !== seatId);
        } else {
            if (selectedSeats.length < maxSeats) {
                seatElement.classList.add('seat-selected');
                selectedSeats.push(seatId);
            } else {
                alert(`ìµœëŒ€ ${maxSeats}ëª…ê¹Œì§€ ì„ íƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            }
        }
    }

    // ì¸ì› ìˆ˜ ì„ íƒ ì‹œ ì„ íƒ ì´ˆê¸°í™”
    function limitSeatSelection() {
        selectedSeats = [];
        document.querySelectorAll('.seat-selected').forEach(seat => {
            seat.classList.remove('seat-selected');
        });
    }

    // í¼ ì œì¶œ ì „ì— ì¢Œì„ ì„ íƒ í™•ì¸
    function validateSeatSelection() {
        const maxSeats = parseInt(document.getElementById('personCount').value);

        if (selectedSeats.length !== maxSeats) {
            document.getElementById('seatError').style.display = 'block';
            return false; // í¼ ì œì¶œ ë°©ì§€
        }

        // ì„ íƒëœ ì¢Œì„ IDì™€ ì¸ì› ìˆ˜ë¥¼ ìˆ¨ê²¨ì§„ í•„ë“œì— ì „ë‹¬
        document.getElementById('seatIds').value = selectedSeats.join(',');
        document.getElementById('personCountHidden').value = maxSeats;

        return true; // í¼ ì œì¶œ í—ˆìš©
    }
</script>

</body>
</html>
